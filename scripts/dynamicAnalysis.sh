#!/bin/bash

INPUT_APK=""
AVD_IMAGE="Nex_API_23"
NUM=5000
OUTPUT_FOLDER="output/sys"

usage() { echo "Usage: $0 [-i input_apk] [-o output_folder] [-a avd_image]" 1>&2; exit 0; }
check_commands(){
    if ! type "adb" > /dev/null; then
        echo "adb not found."
        exit 1
    fi
    if ! type "emulator" > /dev/null; then
        echo "android emulator not found."
        exit 1
    fi
    if [ -z "${ANDROID_HOME}" ]; then
        echo "ANDROID_HOME not set."
        exit 1
    fi
}
while getopts ":i:o:a:h" opt; do
    case "${opt}" in
        i)
            INPUT_APK=${OPTARG}
            ;;
        a)
            AVD_IMAGE=${OPTARG}
            ;;
        o)
            OUTPUT_FOLDER=${OPTARG}
            ;;
        *)
            usage #Help
            ;;
    esac
done
shift $((OPTIND-1))

echo $AVD_IMAGE
echo $OUTPUT_FOLDER
echo $INPUT_APK
#check existance output dir
if [ ! -d "$OUTPUT_FOLDER" ]; then
  mkdir -p "$OUTPUT_FOLDER"
fi

if [ ! -f "$INPUT_APK" ]; then
    echo "Apk not found: $INPUT_APK"
    exit 1
fi

check_commands

ADB=$(which adb)
echo "adb=$ADB"

PKG_NAME=`aapt dump badging "$INPUT_APK"`
PKG_NAME=$(echo $PKG_NAME | grep -oP "(?<=package: name=')[^']*")
FILENAME=$(basename "$INPUT_APK")
echo $FILENAME

#clean starting env
$ADB kill-server > /dev/null 2>&1
$ADB start-server > /dev/null 2>&1

#Have problems running the emulator outside of the $ANDROID_HOME/tools folder
cd "$ANDROID_HOME/tools"

#run android emulator and detach
#$(which emulator) -avd $AVD_IMAGE -no-skin -no-audio -no-window -no-snapshot -debug-no-all -logcat '*:s' -wipe-data > /dev/null 2>&1 &
$(which emulator) -avd $AVD_IMAGE -no-snapshot -debug-no-all -logcat '*:s' -wipe-data > /dev/null 2>&1 &
disown

sleep 50
cd -

#install selected apk
$ADB install ${INPUT_APK}

#generate random seed (bash function)
SEED=$RANDOM
echo "rand seed: $RANDOM"
#run android monkey
$ADB shell monkey -p ${PKG_NAME} -s ${SEED} -v ${NUM} > monkey.txt 2>&1 &

sleep 2

#get process pid
PID=$($ADB shell ps | grep ${PKG_NAME} | awk '{print $2}')
echo "pid: $PID"
#clean output file
truncate -s 0 "${OUTPUT_FOLDER}/${FILENAME}.txt"
$($ADB shell strace -f -p ${PID} > "${OUTPUT_FOLDER}/${FILENAME}.txt" &)

sleep 100

#clean environment
EM=$($ADB devices | grep emulator | cut -f1 )
while read -r line
do
    $ADB -s $line emu kill
done <<< "$EM"

$ADB kill-server
