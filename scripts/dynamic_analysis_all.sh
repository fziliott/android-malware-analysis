#!/bin/bash
#set -e # exit on command errors (so you MUST handle exit codes properly!)

CURR_DIR=$(dirname "$0")
INPUT_FOLDER=""
OUTPUT_FOLDER=""
AVD="Nexus_5_API_22"
NUM="750"
SCRIPT_PATH="$CURR_DIR/dynamic_analysis.sh"
TIMES="dynamic_analysis_times.txt"

usage() {
	echo "Usage: $0 [-i input_folder] [-o output_folder] [-a avd_image] [-n num_actions]" 1>&2
	exit 1
}

while getopts ":i::o::a::n::h" opt; do
	case "${opt}" in
	i)
		INPUT_FOLDER=${OPTARG}
		;;
	o)
		OUTPUT_FOLDER=${OPTARG}
		;;
	a)
		AVD=${OPTARG}
		;;
	n)
		NUM=${OPTARG}
		;;
	*)
		usage #Help
		;;
	esac
done
shift $((OPTIND - 1))

if [ -z "$INPUT_FOLDER" ]; then
	exit 1
fi

#FILES="$INPUT_FOLDER/*"
FILES=$(find "$INPUT_FOLDER" -type f -name "*.apk")
for file in $FILES; do
	if grep -q "$file" "$TIMES"; then
		echo "Skipping $file"
		continue
	fi

	# only consider files
	if [ -f "$file" ]; then
		filename=$(basename "$file")
		extension="${filename##*.}"
		#filename="${filename%.*}"
		COPY_FILE="${filename}.apk"
		if [[ "$extension" != "apk" ]]; then
			cp "$file" "$COPY_FILE"
			file="$COPY_FILE"
		fi

		start=$(date +%s.%N)
		"$SCRIPT_PATH" -i "$file" -o "$OUTPUT_FOLDER" -a "$AVD" -n "$NUM"
		RES=0
		if [ $? -eq 1 ]; then
			RES=1
		fi
		end=$(date +%s.%N)
		runtime=$(python -c "print(${end} - ${start})")

		rm "$COPY_FILE" >/dev/null 2>&1
		echo "${filename},$RES,$runtime" >>"$TIMES"
	fi
done
