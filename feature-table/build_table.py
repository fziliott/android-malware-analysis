from __future__ import print_function
import argparse
import os.path
import csv
import sys
import scipy.sparse
import numpy as np
import table_utils
import pickle

dir_path = os.path.dirname(os.path.realpath(__file__))


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('-f', '--features-file', nargs='?', dest='features')
    parser.add_argument('-i', '--input-folder', nargs='?', dest='input_folder')
    parser.add_argument('-o', '--output-table', nargs='?', dest='output_data')
    parser.add_argument('-l', '--label', nargs='?', dest='label', default='B')
    args = parser.parse_args()

    features_file = ""
    output_file = ""
    input_folder = ""
    if args.features is None:
        sys.exit("No features file selected!")
    else:
        features_file = os.path.abspath(args.features)
        if not os.path.exists(features_file):
            sys.exit("Feature file " + args.features + " does not exists!")

    if args.input_folder is None or os.path.isdir(args.input_folder) is False:
        sys.exit("Input folder not valid!")
    else:
        input_folder = os.path.abspath(args.input_folder)

    if args.output_data is None:
        output_file = os.path.basename(features_file) + "_table"
    else:
        out_dir = os.path.dirname(args.output_data)
        if not os.path.exists(out_dir):
            os.makedirs(out_dir)
        output_file = args.output_data

    return input_folder, features_file, output_file, args.label


def features_list(features_file):
    flist = list()

    with open(features_file, 'r') as file:
        for line in file:
            flist.append(line.rstrip('\n'))

    return flist


def find_element_in_list(element, list_element):
    try:
        index_element = list_element.index(element)
        return index_element
    except ValueError:
        return None


def read_file(features, file):
    # features is a list of features (columns of our table)
    # file is a file with a list of features for that example
    # result is an array of 0s/1s indicating if the feature is present in file
    result = np.zeros(len(features))

    with open(file, 'r') as f:
        for line in f:
            index = find_element_in_list(line.rstrip('\n'), features)
            if index is not None:
                result[index] = True

    return result


def read_file(file):
    # features is a list of features (columns of our table)
    # file is a file with a list of features for that example
    # result is an array of 0s/1s indicating if the feature is present in file
    lines = []

    with open(file, 'r') as f:
        for line in f:
            index = lines.append(line.rstrip('\n'))

    return lines


def make_table_dict(input_dir, output_file, label):
    files = os.listdir(input_dir)

    table = {}

    index = 0
    for file in files:
        file_name = os.path.splitext(os.path.basename(file))[0]
        lines = read_file(os.path.join(input_dir, file))

        table[file_name] = {}
        for line in lines:
            table[file_name][table_utils.DATA].append(line)
        table[file_name][table_utils.CLASS] = label

    return table


def make_table(input_dir, features, label):
    files = os.listdir(input_dir)

    n_samples = len(files)
    n_features = len(features)

    sparse_matrix = scipy.sparse.lil_matrix((n_samples, n_features))

    index = 0
    for file in files:
        res = read_file(features, os.path.join(input_dir, file))

        sparse_matrix[index] = res
        index = index + 1

    if label == 'B':
        labels = np.zeros(len(files))
    else:
        labels = np.ones(len(files))

    data_args = []

    feature_nums = [table_utils.convertToNumber(s) for s in features]
    file_nums = [table_utils.convertToNumber(s) for s in files]

    np.savez_compressed(
        output_file, **{table_utils.DATA: sparse_matrix}, **{table_utils.CLASS:  labels}, **{table_utils.FEATURE_NAMES:  feature_nums}, **{table_utils.FILE_NAMES:  file_nums})


def main():
    input_folder, features_file, output_file, label = parse_args()

    f_list = features_list(features_file)

    f_list.insert(0, 'name')
    f_list.insert(1, 'classification')

    # make_table(input_folder, output_file, f_list, label)
    table = make_table_dict(input_folder, f_list, label)
    with open(output_file, 'wb') as file:
        pickle.dump(table, file, protocol=pickle.HIGHEST_PROTOCOL)

    with open(output_file, 'rb') as file:
        t2 = pickle.load(file)


if __name__ == "__main__":
    main()
